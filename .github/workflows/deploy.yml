name: Android CI

on: [push, pull_request]


jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    - name: Build with Gradle
      run: ./gradlew assembleDebug
          
    - name: upload artifacts
      uses: actions/upload-artifact@v3
      with:
         name: app-debug.apk
         path: app/build/outputs/apk/debug/app-debug.apk
         

  deploy:
     needs: build
     runs-on: ubuntu-latest
     
     steps:

     - name: configure aws credentials
       uses: aws-actions/configure-aws-credentials@master
       with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2
        
     - name: create-upload
       id: create-upload
       run: aws devicefarm create-upload --project-arn ${{secrets.PROJECT_ARN}} --name app-debug.apk --type ANDROID_APP
       
     - name: upload
       id: upload
       run: curl -T app-debug.apk ${{steps.create-upload.outputs.upload.url}}
       
     - name: schedule-run
       id: schedule-run
       run: aws devicefarm schedule-run --project-arn ${{secrets.PROJECT_ARN}} --app-arn ${{steps.create-upload.outputs.upload.arn}}  --device-pool-arn ${{secrets.AWS_DEVICE_POOL_ARN}} --name myRun --test type = BUILTIN_EXPLORER
       
     - name: get-run
       id: get-run
       run: aws devicefarm get-run --arn ${{steps.schedule-run.outputs.run.arn}}
        
#      - name: download artifacts
#        uses: actions/download-artifact@v3
#        with:
#          name: debug
      
#      - name: test
#        uses: realm/aws-devicefarm/test-application@master
#        with:
#         name: test_applications
#         project_arn: ${{ secrets.PROJECT_ARN }}
#         device_pool_arn: ${{ secrets.AWS_DEVICE_POOL_ARN }}
#         #app_file: debug 
#         app_type: ANDROID_APP
#         test_type: BUILTIN_EXPLORER

       
#     - name: schedule a test run
#       id: schedule                
#       uses: realm/aws-devicefarm/schedule-run@master
#       with:
#         name: first_run
#         project_arn: ${{secrets.PROJECT_ARN}}
#         device_pool_arn: ${{secrets.AWS_DEVICE_POOL_ARN}}
#         app_arn: ${{steps.upload-app.outputs.arn}}
#         test_type: BUILTIN_EXPLORER
        
#     - name: get status of run
#       uses: realm/aws-devicefarm/get-run@master
#       with:
#         run_arn: ${{steps.schedule.outputs.arn}}
      
 

      
  
